{
  "Resources": {
   "KnowledgeBaseIdParameter": {
    "Type": "AWS::SSM::Parameter",
    "Properties": {
     "Name": "/RAGChatBot/KNOWLEDGE_BASE_ID",
     "Type": "String",
     "Value": {
         "Ref": "KnowledgeBaseId"
     }
    }
   },
   "InstanceRole": {
    "Type": "AWS::IAM::Role",
    "Properties": {
     "AssumeRolePolicyDocument": {
      "Statement": [
       {
        "Action": "sts:AssumeRole",
        "Effect": "Allow",
        "Principal": {
         "Service": "ec2.amazonaws.com"
        }
       }
      ],
      "Version": "2012-10-17"
     },
     "ManagedPolicyArns": [
      {
       "Fn::Join": [
        "",
        [
         "arn:",
         {
          "Ref": "AWS::Partition"
         },
         ":iam::aws:policy/AdministratorAccess"
        ]
       ]
      }
     ]
    }
   },
   "VPC": {
     "Type": "AWS::EC2::VPC",
     "Properties": {
       "CidrBlock": "172.16.0.0/16",
       "EnableDnsHostnames": true,
       "EnableDnsSupport": true,
       "InstanceTenancy": "default",
       "Tags": [
         {
           "Key": "Name",
           "Value": "defaultVpc"
         }
       ]
     }
   },
   "chatbotAppSecurityGroup": {
       "Type": "AWS::EC2::SecurityGroup",
       "Properties": {
         "GroupDescription": "Allow http and ssh traffic",
         "SecurityGroupIngress": [
           {
             "IpProtocol": "tcp",
             "FromPort": 80,
             "ToPort": 80,
             "CidrIp": "0.0.0.0/0"
           },
           {
             "IpProtocol": "tcp",
             "FromPort": 22,
             "ToPort": 22,
             "CidrIp": "0.0.0.0/0"
           }
         ],
         "VpcId": {
           "Ref": "VPC"
         }
       }
     },
   "chatbotAppInstanceProfile": {
    "Type": "AWS::IAM::InstanceProfile",
    "Properties": {
     "Roles": [
      {
       "Ref": "InstanceRole"
      }
     ]
    }
   },
   "chatbotAppInstance": {
    "Type": "AWS::EC2::Instance",
    "Properties": {
     "ImageId": {
      "Ref": "SsmParameterValue"
     },
     "AvailabilityZone": "us-west-2a",
     "InstanceType": {
      "Ref": "EC2InstanceType"
     },
     "IamInstanceProfile": {
      "Ref": "chatbotAppInstanceProfile"
     },
     "SecurityGroupIds": [
      {
       "Ref": "chatbotAppSecurityGroup"
      }
     ],
     "Tags": [
      {
       "Key": "Name",
       "Value": "RAGChatBot-EC2Stack/chatbotAppInstance"
      }
     ],
     "UserData": {
      "Fn::Base64": "#!/bin/bash\n#!/bin/bash\n\n# Update packages\nsudo apt-get update -y\n\n# Install required packages\nsudo apt-get install -y ec2-instance-connect\nsudo apt-get install -y git\nsudo apt-get install -y python3-pip\nsudo apt-get install -y python3.8-venv\n\n# Clone repository\ncd /home/ubuntu\nsudo git clone https://github.com/ottlseo/bedrock-rag-chatbot.git\n\n# Create virtual environment\nsudo python3 -m venv --copies /home/ubuntu/my_env\nsudo chown -R ubuntu:ubuntu /home/ubuntu/my_env\nsource /home/ubuntu/my_env/bin/activate\n\ncd bedrock-rag-chatbot\n\n# Install dependencies\npip3 install -r requirements.txt\n\n# Create systemd service\nsudo sh -c \"cat <<EOF > /etc/systemd/system/streamlit.service\n[Unit]\nDescription=Streamlit App\nAfter=network.target\n\n[Service]\nUser=ubuntu\nEnvironment='AWS_DEFAULT_REGION=us-west-2'\nWorkingDirectory=/home/ubuntu/bedrock-rag-chatbot\nExecStartPre=/bin/bash -c 'sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8501'\nExecStart=/bin/bash -c 'source /home/ubuntu/my_env/bin/activate && streamlit run streamlit.py --server.port 8501'\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOF\"\n\n# Reload systemd daemon and start the service\nsudo systemctl daemon-reload\nsudo systemctl enable streamlit\nsudo systemctl start streamlit"
     }
    },
    "DependsOn": [
     "InstanceRole"
    ]
   }
  },
  "Parameters": {
   "EC2InstanceType": {
    "Type": "String",
    "Default": "t2.small",
    "AllowedValues": [
     "t2.micro",
     "t2.small",
     "t2.medium",
     "m5.large"
    ]
   },
   "KnowledgeBaseId": {
    "Type": "String",
    "Description": "The ID of the Knowledge Base",
    "Default": ""
   },
   "SsmParameterValue": {
    "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
    "Default": "/aws/service/canonical/ubuntu/server/focal/stable/current/amd64/hvm/ebs-gp2/ami-id"
   }
  },
  "Outputs": {
   "chatbotAppUrl": {
    "Description": "[PLEASE CONNECT IN 5 MINUTES] The URL of chatbot demo generated by AWS RAG-Made-Easy project",
    "Value": {
     "Fn::Join": [
      "",
      [
       "http://",
       {
        "Fn::GetAtt": [
         "chatbotAppInstance",
         "PublicIp"
        ]
       },
       "/"
      ]
     ]
    },
    "Export": {
     "Name": "chatbotAppUrl"
    }
   }
  }
 }